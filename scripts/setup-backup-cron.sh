#!/bin/bash

# üïê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ —á–µ—Ä–µ–∑ cron
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –≤ crontab –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤

set -e

PROJECT_DIR="$(dirname "$(dirname "$(realpath "$0")")")"
BACKUP_SCRIPT="$PROJECT_DIR/scripts/backup.sh"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

error() {
    echo "[ERROR] $1" >&2
    exit 1
}

setup_cron() {
    log "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [[ ! -f "$BACKUP_SCRIPT" ]]; then
        error "–°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_SCRIPT"
    fi
    
    # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
    chmod +x "$BACKUP_SCRIPT"
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º cron –∑–∞–¥–∞–Ω–∏–µ–º
    local temp_cron=$(mktemp)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π crontab
    crontab -l 2>/dev/null > "$temp_cron" || true
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –±—ç–∫–∞–ø–∞
    if grep -q "$BACKUP_SCRIPT" "$temp_cron" 2>/dev/null; then
        log "‚ö†Ô∏è  –ó–∞–¥–∞–Ω–∏–µ –¥–ª—è –±—ç–∫–∞–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ crontab"
        log "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: crontab -l"
        rm "$temp_cron"
        return 0
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 —É—Ç—Ä–∞)
    cat >> "$temp_cron" << EOF

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø Naken Store (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00)
0 2 * * * cd "$PROJECT_DIR" && "$BACKUP_SCRIPT" >> /var/log/naken-backup.log 2>&1
EOF
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π crontab
    crontab "$temp_cron"
    rm "$temp_cron"
    
    # –°–æ–∑–¥–∞–µ–º –ª–æ–≥ —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
    sudo touch /var/log/naken-backup.log
    sudo chmod 666 /var/log/naken-backup.log
    
    log "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
    log "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 —É—Ç—Ä–∞"
    log "üìÑ –õ–æ–≥–∏: /var/log/naken-backup.log"
    
    return 0
}

show_info() {
    cat << EOF

=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–≠–ö–ê–ü–ê–• ===

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
üïê –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 —É—Ç—Ä–∞
üìÅ –ü–∞–ø–∫–∞ –±—ç–∫–∞–ø–æ–≤: /backups/
üìÑ –õ–æ–≥–∏: /var/log/naken-backup.log

=== –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ ===

üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron:
   crontab -l

üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã:
   crontab -e
   (—É–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å backup.sh)

üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –±—ç–∫–∞–ø–æ–≤:
   tail -f /var/log/naken-backup.log

üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø –≤—Ä—É—á–Ω—É—é:
   cd "$PROJECT_DIR" && ./scripts/backup.sh

üì¶ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—ç–∫–∞–ø—ã:
   ls -la /backups/

=== –í–ê–ñ–ù–û ===
üîê –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ 600 (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)
üóÇÔ∏è  –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (>30 –¥–Ω–µ–π) —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
üíæ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤

EOF
}

main() {
    log "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ Naken Store..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    if [[ $EUID -eq 0 ]]; then
        log "‚ö†Ô∏è  –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç root. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        log "sudo –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è."
    fi
    
    setup_cron
    show_info
    
    log "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi 